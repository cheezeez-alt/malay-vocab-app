<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Malay Vocab Revision with Gamification</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#4F46E5', // Indigo 600
                        'primary-dark': '#4338CA', // Indigo 700
                        'success': '#10B981', // Emerald 500
                        'error': '#EF4444', // Red 500
                        'gold': '#FFD700', // Gold for coins
                        'accent': '#F97316', // Orange 500
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom CSS for visual polish and theming */
        .card {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        /* Default Theme */
        .theme-default {
            background-color: #f9fafb; /* gray-50 */
        }
        /* Theme 1: Forest Green */
        .theme-forest {
            background-color: #064E3B; /* Emerald-900 */
        }
        .theme-forest .card {
            background-color: #047857; /* Emerald-600 */
            color: white;
        }
        .theme-forest h1, .theme-forest h2, .theme-forest .text-gray-900, .theme-forest .text-gray-700 {
            color: white !important;
        }
        .theme-forest .text-primary-dark {
             color: #A7F3D0 !important; /* Emerald-200 */
        }
    </style>
</head>
<body class="theme-default min-h-screen flex items-center justify-center p-4">

<div id="app" class="w-full max-w-2xl">
    <h1 class="text-4xl font-extrabold text-center text-gray-900 mb-6">Malay Vocab Builder (Gamified)</h1>

    <!-- Loading/Error Message -->
    <div id="message" class="card bg-white p-6 rounded-xl text-center text-lg text-gray-600 mb-6">Loading vocabulary...</div>

    <!-- Scoreboard/Question Counter -->
    <div id="scoreboard" class="flex flex-wrap justify-between items-center bg-white p-4 rounded-xl card mb-4 hidden gap-2">
        <div class="text-lg font-semibold text-gray-700">
            <span class="text-xl">üî•</span> Streak: <span id="current-streak-display" class="text-accent">0</span>
        </div>
        <div class="text-lg font-semibold text-gray-700">
            Due Words: <span id="due-words-count" class="text-primary-dark">0</span>
        </div>
        <!-- Session Display adapts to show Remediation status -->
        <div class="text-lg font-semibold text-gray-700">
            <span id="session-status-text">Session:</span> <span id="question-counter" class="text-primary-dark">0 / 10</span>
        </div>
        <div class="text-lg font-semibold text-gray-700">
            Correct: <span id="correct-counter" class="text-success">0</span>
        </div>
        <!-- Coin Wallet Display -->
        <div class="text-lg font-bold text-gray-700 flex items-center">
            <svg class="w-6 h-6 text-gold mr-1 fill-current" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM17 14H15C15 15.66 13.66 17 12 17C10.34 17 9 15.66 9 14H7C7 16.76 9.24 19 12 19C14.76 19 17 16.76 17 14ZM17 10C17 7.24 14.76 5 12 5C9.24 5 7 7.24 7 10H9C9 8.34 10.34 7 12 7C13.66 7 15 8.34 15 10H17Z"/>
            </svg>
            Coins: <span id="coin-counter" class="ml-1 text-gold">0</span>
        </div>
    </div>
    
    <!-- Power-Up Shop -->
    <div id="shop-area" class="card bg-white p-6 rounded-xl mb-4 hidden">
        <h2 class="text-2xl font-bold text-center text-primary-dark mb-4">‚ú® Power-Up Shop & Rewards ‚ú®</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <!-- Hint Power-Up -->
            <button id="hint-powerup" onclick="useHint()" disabled class="shop-btn bg-yellow-100 text-yellow-800 p-3 rounded-xl hover:bg-yellow-200 disabled:opacity-50 disabled:cursor-not-allowed transition duration-200">
                <p class="font-bold">Hint (MC only)</p>
                <p class="text-sm">Remove 1 distractor.</p>
                <p class="font-extrabold flex items-center justify-center mt-1">
                    <svg class="w-4 h-4 text-gold fill-current mr-1" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM17 14H15C15 15.66 13.66 17 12 17C10.34 17 9 15.66 9 14H7C7 16.76 9.24 19 12 19C14.76 19 17 16.76 17 14ZM17 10C17 7.24 14.76 5 12 5C9.24 5 7 7.24 7 10H9C9 8.34 10.34 7 12 7C13.66 7 15 8.34 15 10H17Z"/></svg> 5 Coins
                </p>
            </button>
            
            <!-- Skip Power-Up -->
            <button id="skip-powerup" onclick="useSkip()" disabled class="shop-btn bg-red-100 text-red-800 p-3 rounded-xl hover:bg-red-200 disabled:opacity-50 disabled:cursor-not-allowed transition duration-200">
                <p class="font-bold">Skip Word</p>
                <p class="text-sm">Skip current word without session penalty.</p>
                 <p class="font-extrabold flex items-center justify-center mt-1">
                    <svg class="w-4 h-4 text-gold fill-current mr-1" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM17 14H15C15 15.66 13.66 17 12 17C10.34 17 9 15.66 9 14H7C7 16.76 9.24 19 12 19C14.76 19 17 16.76 17 14ZM17 10C17 7.24 14.76 5 12 5C9.24 5 7 7.24 7 10H9C9 8.34 10.34 7 12 7C13.66 7 15 8.34 15 10H17Z"/></svg> 10 Coins
                </p>
            </button>

            <!-- Theme Reward -->
            <button id="theme-powerup-1" onclick="applyTheme('theme-forest')" disabled class="shop-btn bg-green-100 text-green-800 p-3 rounded-xl hover:bg-green-200 disabled:opacity-50 disabled:cursor-not-allowed transition duration-200">
                <p class="font-bold">Forest Theme</p>
                <p class="text-sm">Unlock a new background color.</p>
                 <p class="font-extrabold flex items-center justify-center mt-1">
                    <svg class="w-4 h-4 text-gold fill-current mr-1" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM17 14H15C15 15.66 13.66 17 12 17C10.34 17 9 15.66 9 14H7C7 16.76 9.24 19 12 19C14.76 19 17 16.76 17 14ZM17 10C17 7.24 14.76 5 12 5C9.24 5 7 7.24 7 10H9C9 8.34 10.34 7 12 7C13.66 7 15 8.34 15 10H17Z"/></svg> 50 Coins
                </p>
            </button>
        </div>
        <p class="text-sm text-center mt-3 text-gray-500">Note: Power-Ups are used during the quiz session.</p>
    </div>

    <!-- Navigation/Mode Selection -->
    <div id="game-controls" class="flex justify-center space-x-4 mb-8 hidden">
        <button onclick="startGame('mc')" class="btn-primary bg-primary text-white font-semibold py-3 px-6 rounded-xl hover:bg-primary-dark">
            1. Multiple Choice
        </button>
        <button onclick="startGame('match')" class="btn-primary bg-primary text-white font-semibold py-3 px-6 rounded-xl hover:bg-primary-dark">
            2. Matching
        </button>
        <button onclick="startGame('spell')" class="btn-primary bg-primary text-white font-semibold py-3 px-6 rounded-xl hover:bg-primary-dark">
            3. Spelling Test
        </button>
    </div>
    
    <!-- Game Area -->
    <div id="game-area" class="card bg-white p-6 md:p-10 rounded-xl hidden">
        
        <!-- Power-Up Buttons (Visible during game) -->
        <div id="powerup-buttons" class="flex justify-center space-x-3 mb-6 hidden">
             <button id="in-game-hint" onclick="useHint()" disabled class="p-2 rounded-lg bg-yellow-400 text-yellow-900 font-semibold text-sm disabled:opacity-50 disabled:cursor-not-allowed">
                üí° Hint (5)
            </button>
             <button id="in-game-skip" onclick="useSkip()" disabled class="p-2 rounded-lg bg-red-400 text-red-900 font-semibold text-sm disabled:opacity-50 disabled:cursor-not-allowed">
                ‚è≠Ô∏è Skip (10)
            </button>
        </div>

        <div id="game-container">
            <!-- Game specific content will be rendered here -->
        </div>

        <div id="result-message" class="mt-6 text-center text-xl font-bold hidden"></div>

        <!-- Continue Button -->
        <div class="flex justify-center mt-6">
            <button id="next-button" onclick="nextWord()" class="btn-primary bg-success text-white font-semibold py-3 px-8 rounded-xl hover:bg-primary-dark">
                Next Word
            </button>
        </div>
    </div>
</div>

<script>
    // --- Configuration ---
    const MAX_QUESTIONS = 10; 
    const STREAK_BONUS = 20;
    const HINT_COST = 5;
    const SKIP_COST = 10;
    const THEME_COST = 50;
    
    // IMPORTANT: REPLACE YOUR SPREADSHEET ID AND GID HERE
    const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/1xZwDrLKdhGFjo2yxHelIYn9bRhKynCM6OAIW5VEW44A/gviz/tq?tqx=out:csv&gid=0';
    
    // üõë CRITICAL: PASTE YOUR NEW DEPLOYED GOOGLE APPS SCRIPT EXECUTION API URL HERE!
    const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbweYedKSS5yI0zVXMIm2QKv4-QKv6ZbDIx8R3bYyKRPh946PYb_DJI1hSE2HL88Y50N/exec'; 
    const MAX_RETRIES = 3;
    const INITIAL_DELAY_MS = 1000;

    // --- Global State ---
    let vocabulary = [];
    let dueVocabulary = []; 
    let sessionVocabulary = []; // Current list of words in the active session/loop
    let currentWord = null;
    let currentMode = null;
    let gameActive = false;
    
    let correctAnswersCount = 0; 
    let questionsAttempted = 0; 
    let coins = 0; 
    let streakData = { currentStreak: 0, lastCompletionDate: null, isDailyGoalCompleted: false, activeTheme: 'theme-default' };

    // --- Remediation State ---
    let initialSessionWords = []; // Stores the words from the first 10-question set
    let incorrectWordsInSession = []; // Words failed in the CURRENT loop (used to seed the next loop)
    let isInitialSessionComplete = false;
    let isRemediationPhase = false; 
    let remediationRoundCount = 0;

    // --- DOM Elements ---
    const messageEl = document.getElementById('message');
    const controlsEl = document.getElementById('game-controls');
    const gameAreaEl = document.getElementById('game-area');
    const gameContainerEl = document.getElementById('game-container');
    const resultMessageEl = document.getElementById('result-message');
    const nextButtonEl = document.getElementById('next-button');
    const coinCounterEl = document.getElementById('coin-counter');
    const shopAreaEl = document.getElementById('shop-area');
    const sessionStatusTextEl = document.getElementById('session-status-text');

    // --- Utility Functions ---

    const shuffleArray = (array) => {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    };
    
    const isWordDue = (word) => {
        const intervalDays = parseFloat(word.sr_i) || 0;
        const lastPractice = word.lastPracticeDate ? new Date(word.lastPracticeDate) : null;
        
        if (!lastPractice || intervalDays === 0) {
            return true;
        }

        const nextReviewDate = new Date(lastPractice.getTime());
        nextReviewDate.setDate(nextReviewDate.getDate() + intervalDays);
        
        const today = new Date();
        today.setHours(0, 0, 0, 0); 
        nextReviewDate.setHours(0, 0, 0, 0);

        return today >= nextReviewDate;
    };

    const parseCSV = (csv) => {
        const lines = csv.split('\n').filter(line => line.trim() !== '');
        if (lines.length < 2) return { vocab: [], coins: 0 };

        const header = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
        const data = [];
        let globalCoins = 0;

        for (let i = 1; i < lines.length; i++) {
            const values = lines[i].match(/(".*?"|[^",\r\n]+)(?=\s*,|\s*$)/g)?.map(v => v.trim().replace(/^"|"$/g, '')) || [];
            
            if (values.length >= 10) {
                const row = {};
                row.malay = values[0];
                row.meaning = values[1];
                row.synonym = values[2] || '';
                row.antonym = values[3] || '';
                
                row.lastPracticeStatus = values[4] || ''; 
                row.lastPracticeTimestamp = values[5] || ''; 
                row.sr_n = parseInt(values[6]) || 0; 
                row.sr_ef = parseFloat(values[7]) || 2.5; 
                row.sr_i = parseInt(values[8]) || 0; 
                
                if (i === 1) {
                    globalCoins = parseInt(values[9]) || 0;
                }
                
                row.lastPracticeDate = (values[5] && values[5] !== 'Timestamp') ? values[5].split(' ')[0] : null; 
                
                row.rowNumber = i + 1; 
                
                if (row.malay.trim() !== "") {
                    data.push(row);
                }
            }
        }
        return { vocab: data, coins: globalCoins };
    };
    
    // --- Streak and UI Management ---
    
    const saveStreakData = () => {
        // NOTE: Streak data is stored locally as the Sheet schema doesn't yet support it.
        localStorage.setItem('vocabAppStreak', JSON.stringify({
            currentStreak: streakData.currentStreak,
            lastCompletionDate: streakData.lastCompletionDate,
            activeTheme: streakData.activeTheme
        }));
        updateUIElements();
    };

    const checkDailyReset = () => {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        if (streakData.lastCompletionDate) {
            const lastCompletion = new Date(streakData.lastCompletionDate);
            lastCompletion.setHours(0, 0, 0, 0);
            
            // Check if last completion was NOT today
            if (lastCompletion.toDateString() !== today.toDateString()) {
                streakData.isDailyGoalCompleted = false;
            }
            
            // Check if more than one day has passed (streak broken)
            const yesterday = new Date(today);
            yesterday.setDate(today.getDate() - 1);

            if (lastCompletion.getTime() < yesterday.getTime()) {
                 // Streak broken
                 streakData.currentStreak = 0;
            }
        }
    };
    
    const updateUIElements = () => {
        // Scoreboard updates
        
        // Session status text
        if (isRemediationPhase) {
            sessionStatusTextEl.textContent = `Remediation (${remediationRoundCount}):`;
        } else {
            sessionStatusTextEl.textContent = `Session:`;
        }
        
        // Question counter text
        const sessionTotal = sessionVocabulary.length;
        document.getElementById('question-counter').textContent = isInitialSessionComplete && sessionTotal > 0 && isRemediationPhase ? 
            `${questionsAttempted} / ${sessionTotal}` : 
            `${questionsAttempted} / ${MAX_QUESTIONS}`;

        document.getElementById('correct-counter').textContent = correctAnswersCount;
        document.getElementById('due-words-count').textContent = dueVocabulary.length;
        coinCounterEl.textContent = coins; 
        
        // Streak Display
        document.getElementById('current-streak-display').textContent = streakData.currentStreak;

        // Shop button states (disabled if not enough coins)
        document.getElementById('hint-powerup').disabled = coins < HINT_COST || currentMode !== 'mc';
        document.getElementById('skip-powerup').disabled = coins < SKIP_COST;
        document.getElementById('theme-powerup-1').disabled = coins < THEME_COST || streakData.activeTheme === 'theme-forest';
        
        // In-Game Power-Up button states
        const inGameHintEl = document.getElementById('in-game-hint');
        const inGameSkipEl = document.getElementById('in-game-skip');

        if (inGameHintEl) {
            // Hint is only available during MC mode
            inGameHintEl.disabled = coins < HINT_COST || currentMode !== 'mc' || !gameActive || inGameHintEl.getAttribute('data-used') === 'true';
        }
        if (inGameSkipEl) {
            inGameSkipEl.disabled = coins < SKIP_COST || !gameActive;
        }

        // Apply theme on load/update
        const body = document.body;
        body.className = body.className.split(' ').filter(c => !c.startsWith('theme-')).join(' ');
        body.classList.add(streakData.activeTheme);
        
        // Show/Hide power-up bar based on mode/coins
        const powerupBar = document.getElementById('powerup-buttons');
        if (gameAreaEl.classList.contains('hidden')) {
             powerupBar.classList.add('hidden');
             shopAreaEl.classList.remove('hidden');
        } else {
             powerupBar.classList.remove('hidden');
             shopAreaEl.classList.add('hidden');
        }
    };


    // --- Data Loading with Retry Logic ---

    const loadVocabulary = async () => {
        messageEl.textContent = 'Fetching word list and player data from Google Sheet...';
        
        // Load local streak data first
        const storedStreak = localStorage.getItem('vocabAppStreak');
        if (storedStreak) {
            const data = JSON.parse(storedStreak);
            streakData.currentStreak = data.currentStreak || 0;
            streakData.lastCompletionDate = data.lastCompletionDate;
            streakData.activeTheme = data.activeTheme || 'theme-default';
            checkDailyReset(); // Check streak integrity based on last completion date
        }

        for (let attempt = 1; attempt <= MAX_RETRIES; attempt++) {
            try {
                const cacheBusterUrl = `${SHEET_CSV_URL}&t=${Date.now()}`;
                const response = await fetch(cacheBusterUrl);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const csvText = await response.text();
                const parsedData = parseCSV(csvText);

                vocabulary = parsedData.vocab;
                coins = parsedData.coins; 

                if (vocabulary.length === 0) {
                    messageEl.textContent = 'Error: No valid vocabulary found. Check your sheet content or link.';
                    return;
                }
                
                dueVocabulary = vocabulary.filter(isWordDue);

                messageEl.classList.add('hidden');
                
                // Show game controls and shop
                controlsEl.classList.remove('hidden');
                document.getElementById('scoreboard').classList.remove('hidden'); 
                shopAreaEl.classList.remove('hidden');
                
                console.log(`Successfully loaded ${vocabulary.length} words. ${dueVocabulary.length} are currently due for review. Current Coins: ${coins}`); 
                
                updateUIElements(); 
                
                return; 

            } catch (error) {
                console.warn(`Attempt ${attempt} failed: ${error.message}`);
                
                if (attempt === MAX_RETRIES) {
                    console.error("Failed to load vocabulary after all retries.");
                    messageEl.textContent = `Failed to load vocabulary after ${MAX_RETRIES} attempts. Please check URL and sharing settings.`;
                    return;
                }
                
                const delay = INITIAL_DELAY_MS * Math.pow(2, attempt - 1);
                messageEl.textContent = `Error loading. Retrying in ${delay / 1000}s... (Attempt ${attempt + 1}/${MAX_RETRIES})`;
                await new Promise(resolve => setTimeout(resolve, delay));
            } finally {
                updateUIElements(); 
            }
        }
    };
    
    // --- Server Communication (Google Apps Script) ---
    
    /**
     * Sends the updated SM2 progress metrics to the Google Apps Script for sheet update.
     */
    const updateSheetProgress = async (rowNumber, correct, newMetrics) => {
        // ... (API Key and URL check omitted for brevity, assuming external environment handles it) ...

        const data = {
            action: 'updateProgress', 
            row: rowNumber,
            status: correct ? 'Correct' : 'Wrong',
            sr_n: newMetrics.sr_n,
            sr_ef: newMetrics.sr_ef,
            sr_i: newMetrics.sr_i
        };
        
        const postBody = new URLSearchParams(data).toString();

        const postOptions = {
            method: 'POST',
            mode: 'no-cors', 
            cache: 'no-cache',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: postBody
        };

        try {
            await fetch(GOOGLE_APPS_SCRIPT_URL, postOptions);
            console.log(`Progress for row ${rowNumber} sent successfully.`);
        } catch (error) {
            console.warn(`Failed to send progress update for row ${rowNumber}.`, error);
        }
    };
    
    /**
     * Sends the total coin count to the Google Apps Script for persistence.
     */
    const updateCoinsOnSheet = async (currentCoins) => {
        // ... (API Key and URL check omitted for brevity, assuming external environment handles it) ...

        const data = {
            action: 'updateCoins', 
            newCoins: currentCoins,
        };
        
        const postBody = new URLSearchParams(data).toString();

        const postOptions = {
            method: 'POST',
            mode: 'no-cors', 
            cache: 'no-cache',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: postBody
        };

        try {
            await fetch(GOOGLE_APPS_SCRIPT_URL, postOptions);
            console.log(`Coin count (${currentCoins}) sent successfully.`);
        } catch (error) {
            console.warn(`Failed to send coin update.`, error);
        }
    };


    // --- Spaced Repetition (SuperMemo 2) Algorithm ---
    
    const calculateSM2 = (word, correct) => {
        let n = word.sr_n;
        let ef = word.sr_ef;
        const quality = correct ? 5 : 1;
        
        ef = ef + (0.1 - (5 - quality) * (0.08 + (5 - quality) * 0.02));
        ef = Math.max(1.3, ef); 

        if (correct) {
            n += 1; 
        } else {
            n = 0; 
        }

        let i;
        if (n === 1) {
            i = 1;
        } else if (n === 2) {
            i = 6;
        } else if (n > 2) {
            i = Math.round(word.sr_i * ef); 
        } else { 
            i = 1; 
        }
        
        if (i < 1) i = 1;

        return { 
            sr_n: n, 
            sr_ef: parseFloat(ef.toFixed(2)), 
            sr_i: parseInt(i),
        };
    };
    

    // --- Game Flow Control ---

    const startGame = (mode) => {
        currentMode = mode;
        correctAnswersCount = 0; 
        questionsAttempted = 0; 
        isInitialSessionComplete = false;
        isRemediationPhase = false;
        remediationRoundCount = 0;
        initialSessionWords = [];
        incorrectWordsInSession = [];
        
        let usableVocab = [...dueVocabulary];

        if (mode === 'match') {
            usableVocab = usableVocab.filter(w => w.synonym.trim() !== "" || w.antonym.trim() !== "");
        }
        
        usableVocab.sort((a, b) => {
            if (a.sr_ef !== b.sr_ef) {
                return a.sr_ef - b.sr_ef; 
            }
            return a.sr_n - b.sr_n; 
        });

        sessionVocabulary = usableVocab.slice(0, MAX_QUESTIONS); 
        initialSessionWords = [...sessionVocabulary]; // Store the original 10 words

        if (sessionVocabulary.length === 0) {
            gameAreaEl.classList.remove('hidden');
            gameContainerEl.innerHTML = `
                <h2 class="text-3xl font-bold text-center text-success mb-4">No Words Due!</h2>
                <p class="text-xl text-gray-700 text-center">You're all caught up! Check back tomorrow or refresh your sheet data.</p>
            `;
            controlsEl.classList.remove('hidden');
            shopAreaEl.classList.remove('hidden');
            nextButtonEl.classList.add('hidden');
            return;
        }

        gameAreaEl.classList.remove('hidden');
        controlsEl.classList.add('hidden');
        shopAreaEl.classList.add('hidden');
        resultMessageEl.classList.add('hidden');
        nextButtonEl.classList.add('hidden');
        document.getElementById('in-game-hint').setAttribute('data-used', 'false'); // Reset hint usage
        
        gameActive = true;
        loadQuestion();
        updateUIElements(); // Ensure power-up buttons are correctly enabled/disabled
    };


    const loadQuestion = () => {
        const sessionTotal = isRemediationPhase ? sessionVocabulary.length : MAX_QUESTIONS;
        
        // --- CHECK FOR SESSION END / REMEDIATION START ---
        if (questionsAttempted >= sessionVocabulary.length) {
            
            // 1. Initial Session Complete -> Check for Remediation
            if (!isInitialSessionComplete) {
                isInitialSessionComplete = true;
                
                if (incorrectWordsInSession.length > 0) {
                    // Start Remediation Phase
                    isRemediationPhase = true;
                    remediationRoundCount = 1;
                    sessionVocabulary = shuffleArray([...incorrectWordsInSession]); // Start the first remediation loop
                    incorrectWordsInSession = []; // Clear current fails for next round
                    questionsAttempted = 0; // Reset counter for the remediation round display
                    
                    // Continue to load next question from the new sessionVocabulary
                    currentWord = sessionVocabulary[questionsAttempted]; 
                    
                } else {
                    // Initial Session Complete, 0 failures -> Final End
                    endSession(MAX_QUESTIONS);
                    return;
                }
            } 
            
            // 2. Remediation Round Complete -> Check for Next Remediation Round or Final End
            else if (isRemediationPhase) {
                 if (incorrectWordsInSession.length > 0) {
                    // Failed some words in this remediation loop, start a new one
                    remediationRoundCount++;
                    sessionVocabulary = shuffleArray([...incorrectWordsInSession]);
                    incorrectWordsInSession = [];
                    questionsAttempted = 0;
                    
                    // Continue to load next question from the new sessionVocabulary
                    currentWord = sessionVocabulary[questionsAttempted];
                    
                } else {
                    // All remediation words are finally correct. Final End.
                    endSession(initialSessionWords.length);
                    return;
                }
            }
        }
        
        // --- LOAD NEXT QUESTION ---
        if (!currentWord || (questionsAttempted < sessionVocabulary.length)) {
             currentWord = sessionVocabulary[questionsAttempted];
        }


        resultMessageEl.classList.add('hidden');
        nextButtonEl.classList.add('hidden');
        document.getElementById('in-game-hint').setAttribute('data-used', 'false');
        gameActive = true;
        
        updateUIElements(); 

        gameContainerEl.innerHTML = ''; 

        switch (currentMode) {
            case 'mc':
                renderMultipleChoice();
                break;
            case 'match':
                renderMatchingQuiz();
                break;
            case 'spell':
                renderSpellingTest();
                break;
        }
    };
    
    const endSession = (sessionTotal) => {
        // --- STREAK LOGIC & BONUS ---
        if (!streakData.isDailyGoalCompleted) {
             const today = new Date().toDateString();
             
             const yesterday = new Date();
             yesterday.setDate(yesterday.getDate() - 1);
             const wasCompletedYesterday = streakData.lastCompletionDate && new Date(streakData.lastCompletionDate).toDateString() === yesterday.toDateString();
             
             if (wasCompletedYesterday || streakData.currentStreak === 0) {
                 streakData.currentStreak += 1; 
             } else {
                 // If the streak was broken (e.g., missed a day)
                 streakData.currentStreak = 1; 
             }
             
             streakData.lastCompletionDate = today;
             streakData.isDailyGoalCompleted = true;
             
             saveStreakData();
             
             // Award Streak Bonus
             if (streakData.currentStreak > 1) {
                coins += STREAK_BONUS;
                updateCoinsOnSheet(coins); 
             }
        }
        
        // Render Session Complete Message
        gameContainerEl.innerHTML = `
            <h2 class="text-3xl font-bold text-success mb-4">Session Complete!</h2>
            <p class="text-xl text-gray-700">You mastered ${sessionTotal} words today.</p>
            <p class="text-4xl font-extrabold mt-6">Your Final Score:</p>
            <p class="text-6xl font-extrabold text-primary">${correctAnswersCount} / ${sessionTotal}</p>
            <p class="text-2xl font-extrabold text-gold mt-4 flex justify-center items-center">
                <svg class="w-8 h-8 text-gold mr-1 fill-current" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM17 14H15C15 15.66 13.66 17 12 17C10.34 17 9 15.66 9 14H7C7 16.76 9.24 19 12 19C14.76 19 17 16.76 17 14ZM17 10C17 7.24 14.76 5 12 5C9.24 5 7 7.24 7 10H9C9 8.34 10.34 7 12 7C13.66 7 15 8.34 15 10H17Z"/>
                </svg>
                You earned ${correctAnswersCount} Coins!
            </p>
            ${streakData.currentStreak > 0 ? `<p class="text-3xl font-extrabold text-accent mt-4">üî• STREAK: ${streakData.currentStreak} Days! ${streakData.currentStreak > 1 ? `(+${STREAK_BONUS} Bonus Coins!)` : ''}</p>` : ''}
            <p class="text-sm text-gray-500 mt-6">To start a new session, choose a game mode above.</p>
        `;
        
        // Reset for next session
        loadVocabulary(); 
        controlsEl.classList.remove('hidden');
        shopAreaEl.classList.remove('hidden');
        gameAreaEl.classList.add('hidden');
        nextButtonEl.classList.add('hidden');
    }

    const nextWord = () => {
        questionsAttempted++;
        loadQuestion(); 
    };

    // Called when an answer is submitted/selected
    const processAnswer = (correct) => {
        if (!gameActive) return;

        gameActive = false;
        
        const newMetrics = calculateSM2(currentWord, correct);
        updateSheetProgress(currentWord.rowNumber, correct, newMetrics);
        
        if (correct) {
            correctAnswersCount++; 
            coins++; 
            updateCoinsOnSheet(coins); 
            
            // In Remediation Phase, a correct answer means the word is removed from the fail list
            // Since we're tracking the *next* fail list in incorrectWordsInSession, we don't need to do anything here, 
            // as words are only added to that list on failure. The session will end when the current list is exhausted.
        } else {
            // Incorrect answer: Add the word to the list of words to be repeated in the next loop.
            // We use .find() to avoid duplicates in the same loop, though shuffleArray should prevent immediate repeats.
            if (!incorrectWordsInSession.find(w => w.rowNumber === currentWord.rowNumber)) {
                incorrectWordsInSession.push(currentWord);
            }
        }
        

        updateUIElements(); 
        
        let feedback = correct 
            ? '‚úÖ Correct! You earned 1 Coin.' 
            : '‚ùå Incorrect. Keep practicing!';
            
        feedback += `<br><span class="text-base font-normal">Next review in ${newMetrics.sr_i} days. (Ease Factor: ${newMetrics.sr_ef.toFixed(2)})</span>`;
        
        resultMessageEl.innerHTML = feedback;
        resultMessageEl.classList.remove('text-error', 'text-success', 'text-blue-500', 'text-orange-500');
        resultMessageEl.classList.add(correct ? 'text-success' : 'text-error');
        resultMessageEl.classList.remove('hidden');
        nextButtonEl.classList.remove('hidden');
    };

    // --- Power-Up Shop Logic ---

    const usePowerUp = (type, cost) => {
        if (coins < cost) {
             // Replaced alert() with a console log or a less intrusive UI message
            console.warn(`Insufficient coins: You need ${cost} coins for this! You only have ${coins}.`); 
            resultMessageEl.innerHTML = `<span class="text-error">You need ${cost} coins for this! You only have ${coins}.</span>`;
            resultMessageEl.classList.remove('hidden');
            resultMessageEl.classList.add('text-error');
            return false;
        }
        
        // Deduct coins and save
        coins -= cost;
        updateCoinsOnSheet(coins);
        updateUIElements();
        return true;
    };

    window.useHint = () => {
        if (currentMode !== 'mc' || !gameActive || document.getElementById('in-game-hint').getAttribute('data-used') === 'true') return;
        
        if (!usePowerUp('hint', HINT_COST)) return;

        // Hint Logic: Remove one incorrect distractor
        const correctAnswer = currentWord.meaning.trim();
        const allButtons = document.querySelectorAll('.mc-option');
        
        let removed = false;
        allButtons.forEach(btn => {
            if (removed) return;
            const btnText = btn.textContent.trim();
            if (btnText !== correctAnswer && !btn.disabled) {
                btn.disabled = true;
                btn.classList.add('opacity-30', 'line-through', 'cursor-not-allowed', 'bg-gray-200');
                btn.classList.remove('hover:bg-primary/50');
                removed = true;
            }
        });
        
        document.getElementById('in-game-hint').setAttribute('data-used', 'true'); // Only one hint per question
        updateUIElements();

        resultMessageEl.innerHTML = '<span class="text-blue-500">Hint Used: One incorrect answer removed.</span>';
        resultMessageEl.classList.remove('hidden', 'text-error', 'text-success');
        resultMessageEl.classList.add('text-blue-500');
    };

    window.useSkip = () => {
        if (!gameActive) return;
        if (!usePowerUp('skip', SKIP_COST)) return;

        // Disable all inputs/buttons
        document.querySelectorAll('.mc-option').forEach(btn => btn.disabled = true);
        document.querySelectorAll('.match-btn').forEach(btn => btn.disabled = true);
        document.getElementById('spelling-input')?.setAttribute('disabled', 'true');
        document.getElementById('spell-submit')?.setAttribute('disabled', 'true');
        
        gameActive = false;
        
        // Skip Logic: Treat as Wrong answer in SM-2 and add to remediation pool
        const newMetrics = calculateSM2(currentWord, false);
        updateSheetProgress(currentWord.rowNumber, false, newMetrics);
        
        // Crucially, push the word to the failed list so it comes up again
        if (!incorrectWordsInSession.find(w => w.rowNumber === currentWord.rowNumber)) {
            incorrectWordsInSession.push(currentWord);
        }
        
        questionsAttempted++; // Count as attempted
        
        resultMessageEl.innerHTML = '<span class="text-orange-500">Word Skipped (10 Coins): This word was marked as "Wrong" for review soon.</span>';
        resultMessageEl.classList.remove('hidden', 'text-error', 'text-success');
        resultMessageEl.classList.add('text-orange-500');
        
        nextButtonEl.classList.remove('hidden'); 
        updateUIElements();
    };

    window.applyTheme = (themeClass) => {
        const cost = THEME_COST;
        if (streakData.activeTheme === themeClass) {
             console.warn(`Theme "${themeClass.replace('theme-', '')}" is already active!`);
             resultMessageEl.innerHTML = `<span class="text-gray-500">Theme is already active.</span>`;
             resultMessageEl.classList.remove('hidden');
             return;
        }

        if (!usePowerUp('theme', cost)) return;
        
        // Apply theme logic
        streakData.activeTheme = themeClass;
        saveStreakData();
        
        resultMessageEl.innerHTML = `<span class="text-success">Theme "${themeClass.replace('theme-', '')}" unlocked and applied!</span>`;
        resultMessageEl.classList.remove('hidden', 'text-error', 'text-blue-500', 'text-orange-500');
        resultMessageEl.classList.add('text-success');
        // Do not block flow, allow user to click Next or start game
        setTimeout(() => resultMessageEl.classList.add('hidden'), 3000); 
    };

    // --- Game 1: Multiple Choice (Meaning) ---

    const renderMultipleChoice = () => {
        const word = currentWord.malay;
        const correctAnswer = currentWord.meaning;
        document.getElementById('powerup-buttons').classList.remove('hidden');


        const distractors = shuffleArray(vocabulary
            .filter(w => w.malay !== word)
            .map(w => w.meaning))
            .slice(0, 3);

        const options = shuffleArray([correctAnswer, ...distractors]);
        
        document.getElementById('in-game-hint').classList.remove('hidden'); // Show hint button
        
        const optionHtml = options.map((opt, index) => `
            <button onclick="checkMultipleChoice(this, '${opt.replace(/'/g, "\\'")}', '${correctAnswer.replace(/'/g, "\\'")}')" 
                    id="mc-option-${index}"
                    class="mc-option w-full text-left p-4 my-2 border border-gray-200 rounded-xl bg-gray-50 hover:bg-primary/50 hover:text-white transition duration-200 focus:outline-none focus:ring-4 focus:ring-primary-dark focus:ring-opacity-50">
                ${opt}
            </button>
        `).join('');

        gameContainerEl.innerHTML = `
            <h2 class="text-3xl font-bold text-center text-primary-dark mb-8">What is the meaning of: <span class="text-primary">${word}</span>?</h2>
            <div id="mc-options">
                ${optionHtml}
            </div>
        `;
        updateUIElements();
    };

    window.checkMultipleChoice = (button, selected, correct) => {
        if (!gameActive) return;

        const allButtons = document.querySelectorAll('.mc-option');
        const isCorrect = selected.trim() === correct.trim();
        
        allButtons.forEach(btn => {
            btn.disabled = true;
            const btnText = btn.textContent.trim().replace(/'/g, "\\'");
            
            if (btnText === correct.trim().replace(/'/g, "\\'")) {
                btn.classList.replace('bg-gray-50', 'bg-success');
                btn.classList.add('text-white');
                btn.classList.remove('hover:bg-primary/50');
            } else if (btn === button && !isCorrect) {
                btn.classList.replace('bg-gray-50', 'bg-error');
                btn.classList.add('text-white');
                btn.classList.remove('hover:bg-primary/50');
            }
        });
        document.getElementById('in-game-hint').disabled = true;

        processAnswer(isCorrect);
    };

    // --- Game 2: Matching Quiz (Synonym/Antonym) ---

    const renderMatchingQuiz = () => {
        let targetField = 'synonym';
        let targetType = 'Synonym';
        
        const hasSynonym = currentWord.synonym.trim() !== "";
        const hasAntonym = currentWord.antonym.trim() !== "";

        if (hasSynonym && hasAntonym) {
            if (Math.random() < 0.5) {
                targetField = 'antonym';
                targetType = 'Antonym';
            }
        } else if (hasAntonym) {
            targetField = 'antonym';
            targetType = 'Antonym';
        }

        const getTargetTerm = (word) => {
            return word[targetField].trim();
        };
        
        document.getElementById('in-game-hint').classList.add('hidden'); // Hide hint button

        const correctAnswerTerm = getTargetTerm(currentWord);

        const validDistractors = vocabulary.filter(w => 
            w.rowNumber !== currentWord.rowNumber && 
            w[targetField].trim() !== "" &&
            w[targetField].trim().toLowerCase() !== correctAnswerTerm.toLowerCase()
        );

        const distractors = shuffleArray(validDistractors).slice(0, 3);
        
        let matchedWords = [currentWord, ...distractors];
        shuffleArray(matchedWords); 

        const leftTerms = matchedWords.map(w => ({ term: w.malay, id: w.rowNumber }));
        const rightTerms = matchedWords.map(w => ({ term: getTargetTerm(w), id: w.rowNumber }));

        shuffleArray(rightTerms);

        gameContainerEl.innerHTML = `
            <h2 class="text-3xl font-bold text-center text-primary-dark mb-8">Match the Malay word with its ${targetType}.</h2>
            <div id="match-game" class="flex justify-between space-x-4">
                <div id="left-column" class="flex flex-col w-1/2"></div>
                <div id="right-column" class="flex flex-col w-1/2"></div>
            </div>
        `;
        
        const leftColEl = document.getElementById('left-column');
        const rightColEl = document.getElementById('right-column');

        leftTerms.forEach(item => {
            leftColEl.innerHTML += `<button id="left-${item.id}" data-id="${item.id}" data-type="left" onclick="selectMatch(this)" class="match-btn left-btn p-3 my-2 border border-gray-300 rounded-xl bg-gray-50 hover:bg-primary/20 transition duration-150">${item.term}</button>`;
        });

        rightTerms.forEach(item => {
            rightColEl.innerHTML += `<button id="right-${item.id}" data-id="${item.id}" data-type="right" onclick="selectMatch(this)" class="match-btn right-btn p-3 my-2 border border-gray-300 rounded-xl bg-gray-50 hover:bg-primary/20 transition duration-150">${item.term}</button>`;
        });
        
        document.getElementById(`left-${currentWord.rowNumber}`).classList.remove('bg-gray-50');
        document.getElementById(`left-${currentWord.rowNumber}`).classList.add('bg-primary', 'text-white', 'font-bold', 'ring-2', 'ring-primary-dark');
        updateUIElements();
    };
    
    let selectedRight = null;
    window.selectMatch = (button) => {
        if (!gameActive) return;

        const id = button.getAttribute('data-id');
        const type = button.getAttribute('data-type');
        
        if (type === 'right') {
            document.querySelectorAll('.right-btn').forEach(btn => btn.classList.remove('bg-yellow-200'));
            button.classList.add('bg-yellow-200');
            selectedRight = id;

            // Only consider the target word (currentWord) for the main challenge
            if (id == currentWord.rowNumber) {
                button.classList.remove('bg-yellow-200', 'hover:bg-primary/20');
                button.classList.add('bg-success', 'text-white');
                document.getElementById(`left-${currentWord.rowNumber}`).classList.remove('bg-primary', 'text-white', 'ring-2', 'ring-primary-dark');
                document.getElementById(`left-${currentWord.rowNumber}`).classList.add('bg-success', 'text-white');
                document.querySelectorAll('.match-btn').forEach(btn => btn.disabled = true);
                document.getElementById('in-game-skip').disabled = true; // Disable skip
                processAnswer(true);
            } else if (selectedRight !== null) {
                // Wrong answer
                button.classList.remove('bg-yellow-200', 'hover:bg-primary/20');
                button.classList.add('bg-error', 'text-white');
                document.querySelectorAll('.match-btn').forEach(btn => btn.disabled = true);
                document.getElementById('in-game-skip').disabled = true; // Disable skip
                
                const correctRightBtn = document.getElementById(`right-${currentWord.rowNumber}`);
                if(correctRightBtn) {
                     correctRightBtn.classList.remove('bg-yellow-200', 'hover:bg-primary/20');
                     correctRightBtn.classList.add('bg-success', 'text-white');
                }
                processAnswer(false);
            }
        }
    };


    // --- Game 3: Spelling Test ---

    const renderSpellingTest = () => {
        const meaning = currentWord.meaning;
        let promptHtml = `Spell the Malay word that means: <span class="text-primary">"${meaning}"</span>`;
        let hintText = '';

        if (currentWord.synonym.trim() !== "") {
            hintText += `Synonym: ${currentWord.synonym}. `;
        }
        if (currentWord.antonym.trim() !== "") {
            hintText += `Antonym: ${currentWord.antonym}.`;
        }
        
        if (hintText.trim() !== "") {
             promptHtml += `<div class="text-base font-medium text-gray-500 mt-2">Context: ${hintText.trim()}</div>`;
        }
        
        document.getElementById('in-game-hint').classList.add('hidden'); // Hide hint button

        gameContainerEl.innerHTML = `
            <h2 class="text-3xl font-bold text-center text-primary-dark mb-8">${promptHtml}</h2>
            <div class="flex flex-col items-center space-y-4">
                <input type="text" id="spelling-input" 
                       class="w-full md:w-2/3 p-4 text-xl border-2 border-gray-300 rounded-xl focus:border-primary focus:ring-primary transition duration-150" 
                       placeholder="Type the Malay word here"
                       onkeydown="if(event.key === 'Enter') checkSpelling()">
                <button onclick="checkSpelling()" id="spell-submit" class="btn-primary bg-primary text-white font-semibold py-3 px-8 rounded-xl hover:bg-primary-dark">
                    Submit Answer
                </button>
            </div>
            <div id="spelling-hint" class="mt-4 text-center text-gray-500 hidden"></div>
        `;
        updateUIElements();
    };

    window.checkSpelling = () => {
        if (!gameActive) return;

        const inputEl = document.getElementById('spelling-input');
        const hintEl = document.getElementById('spelling-hint');
        const submitBtn = document.getElementById('spell-submit');
        
        const userAnswer = inputEl.value.trim().toLowerCase();
        const correctAnswer = currentWord.malay.trim().toLowerCase();

        inputEl.disabled = true;
        submitBtn.disabled = true;
        document.getElementById('in-game-skip').disabled = true; // Disable skip

        if (userAnswer === correctAnswer) {
            inputEl.classList.add('border-success', 'ring-4', 'ring-success/50');
            processAnswer(true);
        } else {
            inputEl.classList.add('border-error', 'ring-4', 'ring-error/50');
            hintEl.textContent = `The correct spelling was: "${currentWord.malay}"`;
            hintEl.classList.remove('hidden');
            processAnswer(false);
        }
        
        submitBtn.classList.add('hidden');
    };

    // --- Initialization ---
    window.onload = loadVocabulary;

</script>
</body>
</html>